# AD 预测系统综合指南

## 1. 项目总览

本项目提供了一个基于语音生物标志物和大型模型的非侵入式阿尔茨海默症（AD）早期检测系统。

**核心科学问题**：探索认知障碍早期的语言及脑电信号变化是否存在统一的生物机制。

**核心创新**：
- **概念转换层**：将深度学习特征映射为临床上可解释的概念（例如，语速、句法复杂度）。
- **CRF诊断模型**：学习概念与诊断之间的内在关联。
- **PMM患者分层**：使用GMLVQ算法解决患者异质性问题。
- **Conformal Inference**：为自动语音识别（ASR）提供不确定性量化和统计保证。

### 系统架构
```
┌─────────────────────────────────────────────────────────────┐
│                      输入层：多模态数据                       │
│                 音频 + 文本 + (未来)脑电图                   │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                   特征提取层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ Wav2Vec2     │  │ Whisper ASR  │  │ 文本处理     │     │
│  │ (声学特征)    │  │ (转录文本)    │  │ (句法/语义)   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              🆕 Conformal Inference层                        │
│         为ASR提供不确定性量化（95%预测集）                     │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              🆕 PMM患者分层层 (GMLVQ)                       │
│       基于声学特征的AI引导分层                               │
│   快速进展者 | 中等进展者 | 稳定者                            │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                   概念转换层                                  │
│  底层特征 → 临床概念（语速、停顿等）                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                   CRF诊断层                                  │
│        概念 → 诊断（健康 / MCI / AD）                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                  输出：诊断 + 解释                            │
│            诊断类别 + 置信度 + 临床解释                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 核心技术模块

### 2.1. PMM患者分层 (`src/models/pmm/`)

**目标**：解决患者间的个体差异问题。

**实现**：
- `gmlvq_stratifier.py`: GMLVQ分层器，学习原型向量和最优度量矩阵。
- `feature_extractor.py`: 声学特征提取器，提取基频（F0）、能量、停顿和谱特征等。

**关键技术**：
```python
# GMLVQ核心公式
d(x, p) = (x - p)^T Λ (x - p)  # 马氏距离
Λ = Ω^T Ω                      # 度量矩阵
loss = sigmoid((d+ - d-) / (d+ + d-))  # GMLVQ损失函数
```

### 2.2. Conformal Inference ASR (`src/models/conformal/`)

**目标**：提高ASR对不同方言和口音的鲁棒性，并提供置信度量化。

**实现**：
- `conformal_asr.py`: Conformal ASR的主模块，生成预测集而非单点预测。
- `calibrator.py`: Conformal ASR模型的校准器。
- `conformal_enhanced_asr.py`: 集成了Conformal Prediction的增强型ASR。

**核心算法**：
```python
# 不一致性分数
score(x, y) = 1 - P(y|x)

# 校准阈值
q = ceil((n+1) * coverage) / n
threshold = quantile(scores, q)

# 预测集
C(x) = {y : score(x, y) ≤ threshold}
```
**保证**: P(y_true ∈ C(x)) ≥ 1 - α (其中 α = 1 - 覆盖率)

---

## 3. 快速入门

### 3.1. 安装

```bash
# 克隆项目
git clone <repository>
cd AD_predict

# 安装依赖
pip install -r requirements.txt

# 安装系统依赖 (例如 FFmpeg)
# 在 Debian/Ubuntu 上:
sudo apt-get install ffmpeg
# 在 macOS 上使用 Homebrew:
brew install ffmpeg

# 验证安装
python scripts/verify_installation.py
```

### 3.2. 项目结构
```
AD_predict/
├── src/
│   └── models/
│       ├── asr/
│       ├── conformal/
│       └── pmm/
├── scripts/
│   ├── download_elderly_videos_updated.py
│   ├── evaluate_conformal_asr.py
│   ├── visualize_conformal_comparison.py
│   ├── test_pmm_stratification.py
│   └── run_complete_conformal_evaluation.py
├── data/
│   ├── raw/audio/
│   └── processed/
└── experiments/
    ├── conformal_evaluation/
    └── pmm_evaluation/
```

### 3.3. 运行系统

#### 测试PMM患者分层
```bash
python scripts/test_pmm_stratification.py
```
该脚本将输出分层准确率、混淆矩阵，并在`experiments/pmm_evaluation/`目录中生成可视化图表。

#### 评估Conformal ASR
这是一个完整的工作流程，包括下载视频、评估和可视化。
```bash
python scripts/run_complete_conformal_evaluation.py \
    --max_samples 20 \
    --output_dir experiments/conformal_evaluation
```
该脚本将输出ASR准确率对比、覆盖率、预测集大小，并在`experiments/conformal_evaluation/visualizations/`目录中生成可视化图表。

---

## 4. 评估

### 4.1. ASR评估指标
- **准确率**: 1 - WER
- **词错误率 (WER)**
- **覆盖率**: 真实转录文本在预测集中的比例。
- **预测集大小**: 反映模型的不确定性。

### 4.2. PMM评估指标
- **分层准确率**
- **混淆矩阵**
- **置信度分布**

---

## 5. 常见问题 (FAQ)

**问题1：为什么要使用Conformal Inference？**
答：传统的ASR只提供单一预测，对于有方言或口音的说话者来说可能不可靠。Conformal Inference提供一个预测集合，并保证真实转录以高概率包含在该集合中，从而提高系统的可靠性。

**问题2：如果预测集太大怎么办？**
答：大的预测集表明模型不确定性很高。您可以通过使用更大的ASR模型（如`large-v3`）、增加校准数据量或改进音频预处理来解决这个问题。

**问题3：PMM分层的临床意义是什么？**
答：患者异质性会对单一诊断模型的性能产生负面影响。通过将患者分层为更同质的亚组，我们可以构建更准确和个性化的模型。

---
## 6. 开发路线图

### ✅ 已完成
- [x] 基础ASR系统 (Whisper)
- [x] PMM患者分层 (GMLVQ)
- [x] Conformal Inference ASR
- [x] 声学特征提取
- [x] 评估框架和可视化

### 🚧 进行中
- [ ] 概念转换层的优化
- [ ] CRF诊断模型的训练
- [ ] 端到端系统集成

### 📋 计划中
- [ ] 脑电图（EEG）信号集成
- [ ] 跨语言泛化
- [ ] 临床验证



download_elderly_videos_updated.py - 下载视频✅（你已运行）
test_conformal_real_data.py - 测试Conformal ASR（无需字幕）
test_pmm_standalone.py - 测试PMM分层
evaluate_conformal_asr.py - 完整评估（需要字幕）
run_complete_conformal_evaluation.py - 一键运行所有
visualize_conformal_comparison.py - 生成对比图
verify_installation.py - 验证环境
demo_system_simple.py - 演示系统